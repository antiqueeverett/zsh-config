#!/bin/zsh

# -- gg = GreaterGit

# -- relative difference
function greatergit-diff() {
	# if changes already committed
	if git diff-index --quiet HEAD --; then
		git diff HEAD^ HEAD
	else
		# if changes made (but not staged)
		if git diff --cached --exit-code; then
			git diff
		else
			# if changes staged (but not committed)
			git diff --cached
		fi
	fi
}

# -- safe-pulling submodules
function greatergit-pull() {
	if [[ $(git submodule foreach 'git status') ]]; then
		echo " -- found submodules!"
		echo " -- switching to recursive pull strategy"
		git submodule update --remote
		git pull --recurse-submodules
	else
		git pull
	fi
}

# helper:
function is-submodule() {
	(cd "$(git rev-parse --show-toplevel)/.." &&
		git rev-parse --is-inside-work-tree) | grep -q true
}

# -- safe-pushing with submodules
function greatergit-push() {
	CURRENT_DIR=$PWD
	if [[ $(git submodule foreach 'git status') ]]; then
		echo " -- found submodules!"
		echo " -- switching to check recursive submodule state"
		for dir in $(find $PWD -maxdepth 1 -mindepth 1 -type d); do
			cd $dir
			if [[ -f .git ]]; then
				if [[ $(git diff --stat) != '' ]]; then
					echo
					printf '%s\n' "${PWD##*/}"
					[[ -z $(git status -s) ]] || echo ' -- modified'
					git diff --quiet || echo ' -- dirty' # check working tree
				fi
			else
			fi
		done
		echo -n "\n -- Continue push?  [Y/N]"
		read REPLY
		if [[ $REPLY =~ ^[Yy]$ ]]; then
			git push
		fi
	else
		git push
	fi
	cd $CURRENT_DIR
}

# -- removing a submodule
function greatergit-rm-submodule() {
	git submodule deinit -f -- $1
	rm -rf .git/modules/$1
	git rm -f $1
}

# -- cloning recursive submodules
function greatergit-clone-recursive() {
	git clone --recursive
}

# -- removing files
function greatergit-remove-tracked() {
	git rm --cached $1
	rm -rf $1
}

# -- global report on local repositories
function report() {
	CURRENT_DIR=$PWD
	for dir in $(find $HOME/Repositories -maxdepth 2 -mindepth 1 -type d); do
		cd $dir
		if [ -d .git ]; then
			if [[ $(git diff --stat) != '' ]]; then
				echo
				basename $(git rev-parse --show-toplevel) # get repo name
				[[ -z $(git status -s) ]] || echo ' -- modified'
				git diff --quiet || echo ' -- dirty' # check working tree
			fi
			#[[ -n $(git status -s) ]] || echo ' -- clean'
		else
			git rev-parse --git-dir &>/dev/null
		fi
	done
	cd $CURRENT_DIR
}

# -- checking status on all repositories
alias status=report

# -- removing files
alias ggcloner='greatergit-clone-recursive'

# -- removing files
alias ggrmtracked='greatergit-remove-tracked'

# -- adding remote
alias ggaddorigin='git remote add origin'

# -- cloning
alias ggclone='git clone'

# -- adding and removing a submodules
alias ggaddsub='git submodule add'
alias ggrmsub='greatergit-rm-submodule'

# -- removing changes
alias ggrmchanges='git restore'

# -- checking out
alias ggco='git checkout'

# -- moving files
alias ggm='git mv'

# -- viewing repository size
alias ggsize='git count-objects -vH'

# -- viewing repository status
alias ggs='git status'

# -- adding cache
alias gga='git add .'
alias ggaP='git add --patch $1'

# -- viewing repository status
alias ggc='git commit -m'

# -- resetting
alias ggrh='git reset --hard'
alias ggrs='git reset --soft'

# -- viewing logs
alias ggl='git log'
alias ggrl='git reflog'
alias ggv='git log --pretty="format:%h %G? %aN  %s"'
# ggv verifies commits are signed: G=signed | N=not signed

# -- submodule-pulling
alias ggpull='greatergit-pull'

# -- pushing
alias ggpush='greatergit-push'

# # -- stashing
alias ggst='git stash'

# -- what changed?
alias ggd='greatergit-diff'
alias ggdt='git difftool'

# -- re-basing
alias ggrebase='git rebase -i'

# -- tracked files
alias ggtracked='git ls-tree -r master --name-only'
